<?php

use Phinx\Migration\AbstractMigration;

class addOfficioDailyNotificationsTemplate extends AbstractMigration
{
    public function up()
    {
        $this->execute("ALTER TABLE `members` ADD COLUMN `enable_daily_notifications` ENUM('Y','N') NOT NULL DEFAULT 'N' AFTER `lName`;");
        $sql = <<<EOT
        INSERT INTO `system_templates` (`system_template_id`, `type`, `title`, `subject`, `from`, `to`, `cc`, `bcc`, `template`, `create_date`) VALUES (NULL, 'system', 'Officio Daily Notifications', 'Daily Notifications', 'Officio "no-reply@officio.ca"', '{user: email}', '', '', '<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">\n<html xmlns="http://www.w3.org/1999/xhtml" lang="en-GB">\n<head>\n    <title>Daily Officio Notifications</title>\n\n    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>\n    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>\n\n    <style type="text/css">\n        body {\n            margin: 0;\n            padding: 0;\n            color: #082040;\n        }\n\n        h1 {\n            margin: 0;\n            padding: 0;\n            font-weight: normal;\n        }\n\n        h2 {\n            margin: 0;\n            padding: 0;\n            font-weight: normal;\n        }\n\n        a[x-apple-data-detectors] {\n            color: inherit !important;\n        }\n\n        .today_news_item {\n            border-collapse: collapse;\n            border: 2px solid #E0EDFF;\n            border-radius: 5px;\n            width: 150px;\n        }\n\n        .today_news_item_spacer {\n            width: 15px;\n        }\n\n        .today_news_title {\n            text-align: center;\n            background-color: #E0EDFF;\n            padding: 5px;\n            font-weight: bold;\n        }\n\n        .today_news_count {\n            text-align: center;\n            font-size: 48px;\n        }\n\n        .block_spacer {\n            padding: 10px;\n        }\n    </style>\n\n</head>\n<body>\n<table border="0" cellpadding="0" cellspacing="0" style="border-collapse: collapse;">\n    <tr>\n        <td style="padding: 20px 0 10px; border-bottom: 2px solid #6793CD;">\n            <a href="https://officio.ca/"><img alt="Officio" width="160" height="41" src="{settings: officio url}/images/default/logo_new.png"/></a>\n        </td>\n    </tr>\n\n    <tr>\n        <td style="padding-top: 20px">\n            <div>Hello {user: first name}. Happy {today_date_day}!</div>\n            <br>\n            <div>The following is an update for {today_date}:</div>\n        </td>\n    </tr>\n\n    <tr>\n        <td style="{studio_news_block_style}">\n            <div class="block_spacer">&nbsp;</div>\n            <table border="0" cellpadding="0" cellspacing="0" width="100%" style="border-collapse: collapse; {studio_news_block_style}">\n                <tr>\n                    <td>\n                        <h1>Studio News</h1>\n                    </td>\n                </tr>\n                <tr>\n                    <td>\n                        {studio_news}\n                    </td>\n                </tr>\n            </table>\n        </td>\n    </tr>\n\n    <tr>\n        <td style="{announcements_block_style}">\n            <div class="block_spacer">&nbsp;</div>\n            <table border="0" cellpadding="0" cellspacing="0" width="100%" style="border-collapse: collapse; {announcements_block_style}">\n                <tr>\n                    <td>\n                        <h1>Announcements</h1>\n                    </td>\n                </tr>\n                <tr>\n                    <td>\n                        {announcements}\n                    </td>\n                </tr>\n            </table>\n        </td>\n    </tr>\n\n    <tr>\n        <td>\n            <div class="block_spacer">&nbsp;</div>\n            <table border="0" cellpadding="0" cellspacing="0" width="100%" style="border-collapse: collapse;">\n                <tr>\n                    <td>\n                        <h1>Today\'s Summary</h1>\n                        <h4>New or unread items:</h4>\n                    </td>\n                </tr>\n                <tr>\n                    <td>\n                        {today_news}\n                    </td>\n                </tr>\n            </table>\n        </td>\n    </tr>\n\n    <tr>\n        <td>\n            <div style="padding: 20px 0;">\n                <div style="margin-top: 40px;">For privacy reasons, clients and prospects names are not visible in this email. Please login to your <a href="{settings: officio url}">Officio</a> account for details.</div>\n                <div style="margin-top: 20px;">Wishing you a pleasant day.<br>Team Officio</div>\n            </div>\n        </td>\n    </tr>\n\n    <tr>\n        <td>\n            <div style="padding: 20px 0; border-top: 2px solid #E9EAEC;">\n                <div style="color: #808080; font-size: smaller">To discontinue receiving daily email notifications, go to the Dashboard and toggle off the daily email notification.</div>\n            </div>\n        </td>\n    </tr>\n</table>\n</body>\n</html>', '2021-06-24');
EOT;
        $this->execute($sql);

        // Add new Amazon SES SMTP
        $this->execute("INSERT INTO `superadmin_smtp` (`smtp_id`, `smtp_on`, `smtp_server`, `smtp_port`, `smtp_username`, `smtp_password`, `smtp_use_ssl`) VALUES (3, 'Y', 'email-smtp.ca-central-1.amazonaws.com', '587', '', '', 'tls');");
    }

    public function down()
    {
        $this->execute("DELETE FROM `superadmin_smtp` WHERE  `smtp_id`=3;");

        $this->execute("ALTER TABLE `members` DROP COLUMN `enable_daily_notifications`;");

        $this->execute('DELETE FROM  `system_templates` WHERE `title` = "Officio Daily Notifications"');
    }
}