<?php

use Laminas\Cache\Storage\FlushableInterface;
use Laminas\Cache\Storage\StorageInterface;
use Phinx\Migration\AbstractMigration;

class AddAclRuleDetailUpgradeSubscriptionPlan extends AbstractMigration
{
    public function up()
    {
        $this->execute(
            "INSERT INTO `acl_rule_details` (`rule_id`,`module_id`,`resource_id`,`resource_privilege`,`rule_allow`) VALUES
            (11, 'clients', 'profile', 'upgrade-subscription-plan', 1);"
        );

        /** @var Zend_Db_Adapter_Abstract $db */
        $db = Zend_Registry::get('serviceManager')->get('db');

        $template = '<table>     <tr>         <td>             <img src="{settings: images path}/default/officio_logo_with_bg.png" alt="logo" width="600" height="94" />         </td>     </tr>      <tr>      <td>       <table width="600" align="center" bgcolor="#b3bcbf" border="0" cellpadding="6" cellspacing="1">         <tbody>           <tr>             <td bgcolor="#ffffff">               <table width="100%" border="0" cellpadding="5" cellspacing="0">                 <tbody>                   <tr>                     <td style="font: 11px Arial,Helvetica,sans-serif; text-align: left;" bgcolor="#f0f0f0">                          <table width="100%" border="0" cellpadding="5">                           <tbody>                             <tr>                               <td>                                   <div style="font: 11px Arial,Helvetica,sans-serif;">Dear {admin first name} {admin last name},<br><br>Thank you for your order. Here are your order details:</div>                               </td>                             </tr>                           </tbody>                         </table>                        <table width="100%" border="1" cellpadding="6">                         <tbody>                           <tr>                             <td bgcolor="#ffffff">                               <table width="100%" border="0" cellpadding="0" cellspacing="0">                                 <tbody>                                   <tr>                                     <td style="font: 11px Arial,Helvetica,sans-serif;" nowrap="nowrap"><span style="color: #4F8CBC; font-weight: bold;">Upgrade to OfficioSolo - Prorated</span><br>                                         <strong>Licensee Name:</strong>&nbsp;&nbsp;{company name}                                     </td>                                   </tr>                                 </tbody>                               </table>                             </td>                           </tr>                         </tbody>                       </table>                        <br>                        <table width="100%" bgcolor="#f0f0f0" border="0" cellpadding="0" cellspacing="0">                         <tbody>                           <tr>                             <td colspan="4" style="font: 11px Arial,Helvetica,sans-serif;" bgcolor="#e3e2e2" nowrap="nowrap">                               <span style="font: 11px Arial,Helvetica,sans-serif; font-weight: bold;">Your order summary:</span><br>                               <table width="100%" border="0" cellpadding="5" cellspacing="0">                                 <tbody>                                     <tr>                                         <td style="font: 11px Arial,Helvetica,sans-serif; font-weight: bold;" width="20%">Invoice #:</td>                                         <td style="font: 11px Arial,Helvetica,sans-serif;">{invoice: number}</td>                                     </tr>                                     <tr>                                         <td style="font: 11px Arial,Helvetica,sans-serif; font-weight: bold;">Date:</td>                                         <td style="font: 11px Arial,Helvetica,sans-serif;">{invoice: date}</td>                                     </tr>                                     <tr>                                         <td style="font: 11px Arial,Helvetica,sans-serif; font-weight: bold;">Next billing date:</td>                                         <td style="font: 11px Arial,Helvetica,sans-serif;">{next billing date}</td>                                     </tr>                                 </tbody>                               </table>                             </td>                           </tr>                         </tbody>                       </table>                                               <br>                          <table width="100%" bgcolor="#f0f0f0" border="0" cellpadding="3" cellspacing="0" style=\'background: url("{settings: images path}/default/officio_watermark.png") no-repeat center;\'>                             <tr>                                   <td style="font: 11px Arial,Helvetica,sans-serif;" width="40%"><strong>Description</strong></td>                                   <td style="font: 11px Arial,Helvetica,sans-serif;" align="center" width="20%"><strong>Qty</strong></td>                                   <td style="font: 11px Arial,Helvetica,sans-serif;" align="center" width="20%"><strong>Unit Price</strong></td>                                   <td style="font: 11px Arial,Helvetica,sans-serif;" align="right" width="20%"><strong>Amount</strong></td>                             </tr>                             <tr>                                   <td style="font: 11px Arial,Helvetica,sans-serif;"><span style="font-weight: bold;">Upgrade to OfficioSolo - Prorated</span>                                       <br/>Includes:<br>                                         - {invoice: free storage} Gb of space<br>                                         - {invoice: free users} user license(s)                                   </td>                                   <td style="font: 11px Arial,Helvetica,sans-serif;" align="center">{invoice: quantity}</td>                                   <td style="font: 11px Arial,Helvetica,sans-serif;" align="center">{invoice: currency} {invoice: subscription fee}</td>                                   <td style="font: 11px Arial,Helvetica,sans-serif;" align="right">{invoice: currency} {invoice: subscription fee}</td>                             </tr>                             <tr {invoice: hide if empty discount}>                                   <td style="font: 11px Arial,Helvetica,sans-serif;">Discount</td>                                   <td style="font: 11px Arial,Helvetica,sans-serif;" align="center">&nbsp;</td>                                   <td style="font: 11px Arial,Helvetica,sans-serif;" align="center">&nbsp;</td>                                   <td style="font: 11px Arial,Helvetica,sans-serif;" align="right">{invoice: currency} -{invoice: discount}</td>                             </tr>                             <tr>                                 <td style="font: 11px Arial,Helvetica,sans-serif; font-weight: bold;">Additional user license(s)</td>                                 <td style="font: 11px Arial,Helvetica,sans-serif;" align="center">{invoice: additional users}</td>                                 <td style="font: 11px Arial,Helvetica,sans-serif;" align="center">{invoice: currency} {invoice: price per user}</td>                                 <td style="font: 11px Arial,Helvetica,sans-serif;" align="right">{invoice: currency} {invoice: additional users fee}</td>                             </tr>                             <tr><td colspan="4"><hr></td></tr>                             <tr>                                   <td style="font: 11px Arial,Helvetica,sans-serif;">&nbsp;</td>                                   <td style="font: 11px Arial,Helvetica,sans-serif;" align="center">&nbsp;</td>                                   <td style="font: 11px Arial,Helvetica,sans-serif;" align="right">Sub Total</td>                                   <td style="font: 11px Arial,Helvetica,sans-serif;" align="right">{invoice: currency} {invoice: subtotal}</td>                             </tr>                             <tr>                                   <td colspan="3" style="font: 11px Arial,Helvetica,sans-serif;" align="right">GST/HST (Registration No. 896191244)</td>                                   <td style="font: 11px Arial,Helvetica,sans-serif;" align="right">{invoice: currency} {invoice: gst/hst fee}</td>                             </tr>                             <tr>                                   <td style="font: 11px Arial,Helvetica,sans-serif;">&nbsp;</td>                                   <td style="font: 11px Arial,Helvetica,sans-serif;" align="center">&nbsp;</td>                                   <td style="font: 11px Arial,Helvetica,sans-serif; font-weight: bold;" align="right">Total</td>                                   <td style="font: 11px Arial,Helvetica,sans-serif;" align="right">{invoice: currency} {invoice: total}</td>                             </tr>                             <tr>                                   <td style="font: 11px Arial,Helvetica,sans-serif;">&nbsp;</td>                                   <td style="font: 11px Arial,Helvetica,sans-serif;" align="center">&nbsp;</td>                                   <td style="font: 11px Arial,Helvetica,sans-serif; font-weight: bold;" align="right">Paid</td>                                   <td style="font: 11px Arial,Helvetica,sans-serif;" align="right">{invoice: currency} -{invoice: amount paid}</td>                             </tr>                             <tr>                               <td colspan="4" nowrap="nowrap" height="38">                                 <table width="100%" border="0">                                     <tr>                                       <td style="font: 11px Arial,Helvetica,sans-serif;" width="18%" nowrap="nowrap"><strong>Payment method:</strong></td>                                       <td style="font: 11px Arial,Helvetica,sans-serif;" width="82%">{invoice: payment method}</td>                                     </tr>                                 </table>                               </td>                             </tr>                         </table>                          <table width="100%" border="0" cellpadding="5">                           <tbody>                             <tr>                               <td style="font: 11px Arial,Helvetica,sans-serif;">                                   <p><strong>A couple of quick notes and reminders:</strong></p>                                   <ul>                                     <li><strong>Payment:</strong> Your credit card&nbsp; has been debited with {invoice: currency} {invoice: amount paid}, your card statement will list &quot;UNIQUES SOFTWARE&quot;.</li>                                     <li><strong>My account:</strong> You can always access your invoices by logging into Officio, and going to Admin | Company Details | Company Invoices. </li>                                   </ul>                                   <p>Thank you for your order. If we can do anything to enhance your experience with Officio, please do not hesitate to let us know.</p>                                   <br><br>                                   <p>Best regards,</p>                                   <p><strong>The Officio Team</strong></p>                                   <p>officio.ca, a product of Uniques Software Corp.</p>                               </td>                             </tr>                           </tbody>                         </table>                          <p>                     </td>                   </tr>                 </tbody>               </table>             </td>           </tr>         </tbody>       </table>     </td>   </tr> </table>';

        $db->insert(
            'system_templates',
            array(
                'type'        => 'system',
                'title'       => 'Upgrade to OfficioSolo',
                'subject'     => 'Upgrade to OfficioSolo',
                'from'        => 'support@uniques.ca',
                'to'          => '{company email}',
                'cc'          => '',
                'bcc'         => 'support@uniques.ca',
                'template'    => $template,
                'create_date' => date('Y-m-d')
            )
        );

        /** @var $cache StorageInterface */
        $cache = Zend_Registry::get('serviceManager')->get('cache');
        if ($cache instanceof FlushableInterface) {
            $cache->flush();
        }
    }

    public function down()
    {
        $this->execute("DELETE FROM `acl_rule_details` WHERE  `rule_id`=11 AND `module_id`='clients' AND `resource_id`='profile' AND `resource_privilege`='upgrade-subscription-plan';");

        $this->execute('DELETE FROM  `system_templates` WHERE `title` = "Upgrade to OfficioSolo";');

        /** @var $cache StorageInterface */
        $cache = Zend_Registry::get('serviceManager')->get('cache');
        if ($cache instanceof FlushableInterface) {
            $cache->flush();
        }
    }
}